{% extends 'base.html' %}

{% block title %}{{ data_source.name }} - AI Analyst{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Data Source Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'data_source_list' %}">Data Sources</a></li>
                    <li class="breadcrumb-item active">{{ data_source.name }}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-1" id="ds-name-display">{{ data_source.name }} <button id="rename-save-btn" class="btn btn-link btn-sm d-none" onclick="saveRename()"><i class="fas fa-check text-success"></i></button><button id="rename-cancel-btn" class="btn btn-link btn-sm d-none" onclick="cancelRename()"><i class="fas fa-times text-danger"></i></button></h1>
<div id="ds-name-edit-row" class="d-none" style="max-width:500px; margin-bottom:1rem; position:relative;">
  <div style="position:relative;">
    <input type="text" id="ds-name-input" class="form-control form-control-lg pr-5" value="{{ data_source.name }}" style="max-width:350px; padding-right:70px;">
    <div style="position:absolute; top:50%; right:10px; transform:translateY(-50%); display:flex; gap:0.25rem;">
      <button id="rename-save-btn-inline" class="btn btn-light btn-sm p-1 m-0 border-0" onclick="saveRename()" tabindex="0" title="Save" aria-label="Save" style="box-shadow:none;"><i class="fas fa-check"></i></button>
      <button id="rename-cancel-btn-inline" class="btn btn-light btn-sm p-1 m-0 border-0" onclick="cancelRename()" tabindex="0" title="Cancel" aria-label="Cancel" style="box-shadow:none;"><i class="fas fa-times"></i></button>
    </div>
  </div>
</div>
<p class="text-muted" id="ds-desc-display">{{ data_source.description|default:"No description provided" }} <button id="desc-save-btn" class="btn btn-link btn-sm d-none" onclick="saveDescription()"><i class="fas fa-check text-success"></i></button><button id="desc-cancel-btn" class="btn btn-link btn-sm d-none" onclick="cancelDescription()"><i class="fas fa-times text-danger"></i></button></p>
<div id="ds-desc-edit-row" class="d-none" style="max-width:500px; position:relative;">
  <div style="position:relative;">
    <textarea id="ds-desc-input" class="form-control pr-5" rows="2" style="max-width:400px; padding-right:70px;"></textarea>
    <div style="position:absolute; top:50%; right:10px; transform:translateY(-50%); display:flex; gap:0.25rem;">
      <button id="desc-save-btn-inline" class="btn btn-light btn-sm p-1 m-0 border-0" onclick="saveDescription()" tabindex="0" title="Save" aria-label="Save" style="box-shadow:none;"><i class="fas fa-check"></i></button>
      <button id="desc-cancel-btn-inline" class="btn btn-light btn-sm p-1 m-0 border-0" onclick="cancelDescription()" tabindex="0" title="Cancel" aria-label="Cancel" style="box-shadow:none;"><i class="fas fa-times"></i></button>
    </div>
  </div>
</div>
        </div>
        <div class="d-flex align-items-center">
            <a href="{% url 'question_form' data_source.id %}" class="btn btn-primary me-2">
                <i class="fas fa-question-circle me-2"></i>Ask Questions
            </a>
            <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-chart-line me-2"></i>Create Analysis
            </a>
            <div class="dropdown">
                <button class="btn btn-link p-0 ms-1" type="button" id="dataSourceActions" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 1.6rem;">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dataSourceActions">
                    <li><a class="dropdown-item" href="#" onclick="showRenameInput(); return false;">Rename</a></li>
<li><a class="dropdown-item" href="#" onclick="showDescriptionInput(); return false;">Change Description</a></li>
<li><a class="dropdown-item" href="#" onclick="showFileModal(); return false;">Update Data Source</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteDataSourceModal(); return false;"><i class="fas fa-trash-alt me-2"></i>Delete Data Source</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Delete Data Source Modal -->
    <div class="modal fade" id="deleteDataSourceModal" tabindex="-1" aria-labelledby="deleteDataSourceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteDataSourceModalLabel"><i class="fas fa-trash-alt me-2"></i>Delete Data Source</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete the data source <strong>{{ data_source.name }}</strong>?</p>
            <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone. All analyses associated with this data source will also be deleted.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deleteDataSourceForm" method="post" action="{% url 'data_source_delete' data_source.id %}" style="margin-bottom: 0;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash-alt me-2"></i>Delete Permanently
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% if error %}
        <div class="alert alert-danger">
            <h4 class="alert-heading">Error loading data</h4>
            <p>{{ error }}</p>
        </div>
    {% endif %}

    <!-- Data Preview & Overview -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0">Data Preview</h5>
                    <button class="btn btn-sm btn-outline-primary refresh-preview">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        {% if preview_data %}
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        {% for column in columns %}
                                            <th>{{ column.name }} <small class="text-muted">({{ column.type }})</small></th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in preview_data %}
                                         <tr>
                                            {% for cell in row %}
                                                <td>{{ cell|default:""|stringformat:"s"|truncatechars:50 }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="p-4 text-center">
                                <i class="fas fa-table fa-3x text-muted mb-3"></i>
                                <h5>No preview available</h5>
                                <p class="text-muted">Preview could not be generated for this data source.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Showing first 10 rows of the dataset
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Data Source Information -->
            <div class="card shadow-sm mb-4">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Data Source Information</h5>

                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">{{ data_source.created_at|date:"M d, Y" }}</dd>

                        {% if data_source.file %}
                            <dt class="col-sm-5">File Type</dt>
                            <dd class="col-sm-7">{{ data_source.file_type|upper }}</dd>
                        {% endif %}

                        {% if data_source.source_type != 'file' %}
                            <dt class="col-sm-5">Host</dt>
                            <dd class="col-sm-7">{{ data_source.host }}:{{ data_source.port }}</dd>

                            <dt class="col-sm-5">Database</dt>
                            <dd class="col-sm-7">{{ data_source.database }}</dd>
                        {% endif %}

                        {% if columns %}
                            <dt class="col-sm-5">Columns</dt>
                            <dd class="col-sm-7">{{ columns|length }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Quick Analysis -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Quick Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="dataStatistics" class="mb-4">
                        <h6 class="text-primary">Data Statistics</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-table me-2 text-primary"></i>Total Columns</span>
                                <span class="badge bg-primary rounded-pill">{{ columns|length }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-hashtag me-2 text-info"></i>Numeric Columns</span>
                                <span class="badge bg-info rounded-pill" id="numericColsCount">{{ numeric_columns|length }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-font me-2 text-success"></i>Text Columns</span>
                                <span class="badge bg-success rounded-pill" id="textColsCount">{{ text_columns|length }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-calendar-alt me-2 text-warning"></i>Date Columns</span>
                                <span class="badge bg-warning rounded-pill" id="dateColsCount">{{ date_columns|length }}</span>
                            </li>
                        </ul>
                        <div id="columnTypeDetails" class="mt-3 small">
                            <div id="numericColsList" class="mb-2" style="display:none">
                                <strong class="text-info"><i class="fas fa-hashtag me-1"></i>Numeric:</strong> <span class="text-muted"></span>
                            </div>
                            <div id="textColsList" class="mb-2" style="display:none">
                                <strong class="text-success"><i class="fas fa-font me-1"></i>Text:</strong> <span class="text-muted"></span>
                            </div>
                            <div id="dateColsList" class="mb-2" style="display:none">
                                <strong class="text-warning"><i class="fas fa-calendar-alt me-1"></i>Date:</strong> <span class="text-muted"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-chart-line me-1"></i>Full Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-robot me-2 text-primary"></i>AI-Generated Insights</h5>
        </div>
        <div class="card-body">
            <div id="aiInsights">
                <!-- AI insights will be loaded here -->
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <h5 class="mb-1">Generating insights...</h5>
                        <p class="mb-0 text-muted">AI is analyzing your data to discover patterns and insights.</p>
                    </div>
                </div>
            </div>
            <div id="aiInsightsResult" class="mt-3" style="display: none;">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-lightbulb text-warning me-2"></i>Key Findings</h5>
                                <ul class="list-unstyled mb-0" id="keyFindings">
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Loading findings...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-chart-pie text-primary me-2"></i>Data Composition</h5>
                                <p class="card-text" id="dataComposition">Analyzing data composition...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Potential Issues</h5>
                                <ul class="list-unstyled mb-0" id="dataIssues">
                                    <li><i class="fas fa-info-circle text-info me-2"></i>Checking for issues...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Automatic Visualizations -->
    <h2 class="h4 mb-3">Automatic Visualizations</h2>
    <style>
    /* Ensure charts stay in frame and are visually balanced */
    #autoVisualizations .card-body {
        min-height: 340px;
    }
    .visualization-canvas-container {
        min-width: 280px;
        max-width: 48%;
        height: 300px;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
    }
    .visualization-canvas-container canvas {
        height: 250px !important;
        max-height: 250px;
        width: 100% !important;
        max-width: 100%;
    }
    @media (max-width: 900px) {
        .visualization-canvas-container {
            max-width: 100%;
        }
    }
    </style>
    <div id="autoVisualizations" class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Automatic Visualizations</h5>
            <div>
                <select id="visualizationColumnDropdown" class="form-select form-select-sm" style="width:auto; display:inline-block;"></select>
            </div>
        </div>
        <div class="card-body" id="visualizationCharts">
            <div class="d-flex flex-wrap justify-content-between">
                <div class="visualization-canvas-container me-3">
                    <h6 class="text-center">Distribution</h6>
                    <canvas id="distributionChart"></canvas>
                </div>
                <div class="visualization-canvas-container">
                    <h6 class="text-center">Values per Column</h6>
                    <canvas id="valueCountsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- AI Insights Result Container (populated by JS) -->
    <div id="aiInsightsResult" class="mt-3"></div>
    <!-- The extra JS for insights and chart rendering should be placed in the extra_js block at the bottom of the template. -->

    <!-- Analyses Section -->
    <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <h2 class="h4 mb-0">Previous Analyses</h2>
        <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-plus-circle me-1"></i>New Analysis
        </a>
    </div>

    {% if analyses %}
        <div class="row" id="analyses">
            {% for analysis in analyses %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <h5 class="mb-0">{{ analysis.name }}</h5>
                            <span class="badge {% if analysis.status == 'completed' %}bg-success{% elif analysis.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ analysis.status|title }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ analysis.description|default:"No description"|truncatechars:100 }}</p>
                            <div class="d-flex align-items-center text-muted small mb-3">
                                <div><i class="fas fa-calendar-alt me-1"></i>{{ analysis.created_at|date:"M d, Y" }}</div>
                                <div class="ms-3"><i class="fas fa-chart-bar me-1"></i>{{ analysis.get_analysis_type_display }}</div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'run_analysis' analysis.id %}" class="btn btn-sm btn-outline-primary flex-grow-1 me-1">
                                    <i class="fas fa-eye me-1"></i>View Analysis
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="showDeleteAnalysisModal({{ analysis.id }}, '{{ analysis.name|escapejs }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card shadow-sm text-center p-4 mb-4">
            <div class="py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                <h3>No Analyses Yet</h3>
                <p class="text-muted mb-4">Create your first analysis to get detailed insights about your data.</p>
                <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i>Create Your First Analysis
                </a>
            </div>
        </div>
    {% endif %}
</div>
<!-- Delete Analysis Modal -->
<div class="modal fade" id="deleteAnalysisModal" tabindex="-1" aria-labelledby="deleteAnalysisModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteAnalysisModalLabel"><i class="fas fa-trash-alt me-2"></i>Delete Analysis</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the analysis <strong id="analysisNameToDelete"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteAnalysisForm" method="post" action="" style="margin-bottom: 0;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt me-2"></i>Delete Permanently
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<!-- Modal for file upload -->
<div class="modal fade" id="updateFileModal" tabindex="-1" aria-labelledby="updateFileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateFileModalLabel">Update Data Source File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateFileForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="updateFileInput" class="form-label">Upload New CSV File</label>
            <input type="file" class="form-control" id="updateFileInput" name="file" accept=".csv">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveFileUpdate()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Inline Rename ---
function showRenameInput() {
  document.getElementById('ds-name-display').classList.add('d-none');
  document.getElementById('ds-name-edit-row').classList.remove('d-none');
  const input = document.getElementById('ds-name-input');
  input.focus();
  input.select();
  input.onkeydown = function(e) {
    if (e.key === 'Enter') { saveRename(); }
    if (e.key === 'Escape') { cancelRename(); }
  };
}
function cancelRename() {
  document.getElementById('ds-name-edit-row').classList.add('d-none');
  document.getElementById('ds-name-display').classList.remove('d-none');
}
function saveRename() {
  const newName = document.getElementById('ds-name-input').value;
  const pk = {{ data_source.id }};
  fetch(`/data-sources/${pk}/rename/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Accept': 'application/json',
    },
    body: new URLSearchParams({name: newName})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('ds-name-display').childNodes[0].nodeValue = data.name + ' ';
      cancelRename();
    } else {
      showError(data.error || 'Failed to rename.');
    }
  }).catch(() => showError('Failed to rename.'));
}
// --- Inline Description ---
function showDescriptionInput() {
  const desc = document.getElementById('ds-desc-display').childNodes[0].nodeValue.trim();
  document.getElementById('ds-desc-display').classList.add('d-none');
  document.getElementById('ds-desc-edit-row').classList.remove('d-none');
  const textarea = document.getElementById('ds-desc-input');
  textarea.value = desc === 'No description provided' ? '' : desc;
  textarea.focus();
  textarea.onkeydown = function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); saveDescription(); }
    if (e.key === 'Escape') { cancelDescription(); }
  };
}
function cancelDescription() {
  document.getElementById('ds-desc-edit-row').classList.add('d-none');
  document.getElementById('ds-desc-display').classList.remove('d-none');
}
function saveDescription() {
  const newDesc = document.getElementById('ds-desc-input').value;
  const pk = {{ data_source.id }};
  fetch(`/data-sources/${pk}/update-description/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'Accept': 'application/json',
    },
    body: new URLSearchParams({description: newDesc})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('ds-desc-display').childNodes[0].nodeValue = data.description;
      cancelDescription();
    } else {
      showError(data.error || 'Failed to update description.');
    }
  }).catch(() => showError('Failed to update description.'));
}
// --- File Modal ---
function showFileModal() {
  var modal = new bootstrap.Modal(document.getElementById('updateFileModal'));
  modal.show();
}
function saveFileUpdate() {
  const pk = {{ data_source.id }};
  const form = document.getElementById('updateFileForm');
  const fileInput = document.getElementById('updateFileInput');
  if (!fileInput.files.length) return;
  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  fetch(`/data-sources/${pk}/update-file/`, {
    method: 'POST',
    headers: {'X-CSRFToken': getCSRFToken()},
    body: fd
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      var modal = bootstrap.Modal.getInstance(document.getElementById('updateFileModal'));
      modal.hide();
      // Optionally reload or show a success message
      location.reload();
    } else {
      showError(data.error || 'Failed to update file.');
    }
  }).catch(() => showError('Failed to update file.'));
}
</script>
<script>
    let distributionChart = null;
    let valueCountsChart = null;
    let scatterChart = null;
    
    // Function to handle deletion of an analysis
    function showDeleteAnalysisModal(analysisId, analysisName) {
        document.getElementById('analysisNameToDelete').textContent = analysisName;
        document.getElementById('deleteAnalysisForm').action = `/analysis/${analysisId}/delete/`;
        
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteAnalysisModal'));
        deleteModal.show();
    }
    
    // Function to show the data source deletion modal
    function showDeleteDataSourceModal() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteDataSourceModal'));
        deleteModal.show();
    }
    let numericColumns = [];
    let selectedColumn = null;
    let allVisualizations = {};
    const dataSourceId = {{ data_source.id }};

    function renderDropdown(columns, current) {
        const dropdown = document.getElementById('visualizationColumnDropdown');
        dropdown.innerHTML = '';
        columns.forEach(col => {
            const opt = document.createElement('option');
            opt.value = col;
            opt.textContent = col;
            if (col === current) opt.selected = true;
            dropdown.appendChild(opt);
        });
    }

    function renderCharts(visualizations) {
        // Value counts chart with improved options
        const val = visualizations.value_counts;
        const valCtx = document.getElementById('valueCountsChart').getContext('2d');
        if (valueCountsChart) valueCountsChart.destroy();
        valueCountsChart = new Chart(valCtx, {
            type: val.type,
            data: {
                labels: val.labels,
                datasets: [{
                    label: val.title,
                    data: val.data,
                    backgroundColor: val.background_color,
                    borderColor: val.border_color,
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: true, 
                aspectRatio: 2,
                plugins: {
                    title: {
                        display: true,
                        text: val.title,
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toLocaleString()}`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: val.x_axis_label || 'Values'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: val.y_axis_label || 'Count'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Histogram chart with improved options
        const dist = visualizations.histogram;
        const distCtx = document.getElementById('distributionChart').getContext('2d');
        if (distributionChart) distributionChart.destroy();
        distributionChart = new Chart(distCtx, {
            type: dist.type,
            data: {
                labels: dist.labels,
                datasets: [{
                    label: dist.title,
                    data: dist.data,
                    backgroundColor: dist.background_color,
                    borderColor: dist.border_color,
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: true, 
                aspectRatio: 2,
                plugins: {
                    title: {
                        display: true,
                        text: dist.title,
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Range ${context.label}: ${context.raw.toLocaleString()} records`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: dist.x_axis_label || 'Ranges'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: dist.y_axis_label || 'Frequency'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Scatter plot with improved tooltips and options
        const scatter = visualizations.scatter;
        const scatterCanvas = document.getElementById('scatterChart');
        if (scatterCanvas) {
            if (scatterChart) scatterChart.destroy();
            if (scatter) {
                const scatterCtx = scatterCanvas.getContext('2d');
                scatterChart = new Chart(scatterCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: scatter.title,
                            data: scatter.labels.map((x, i) => ({ 
                                x: x, 
                                y: scatter.data[i],
                                // Store additional data for tooltips
                                tooltip: scatter.point_labels && i < scatter.point_labels.length ? 
                                         scatter.point_labels[i] : `Row ${x}: ${scatter.data[i]}`
                            })),
                            backgroundColor: scatter.background_color,
                            borderColor: scatter.border_color
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: true, 
                        aspectRatio: 2, 
                        parsing: false,
                        plugins: {
                            title: {
                                display: true,
                                text: scatter.title,
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        // Use the custom tooltip text if available
                                        return context.raw.tooltip || `Row ${context.raw.x}: ${context.raw.y}`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: scatter.x_axis_label || 'Row Index'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: scatter.y_axis_label || 'Value'
                                }
                            }
                        }
                    }
                });
            } else {
                scatterCanvas.getContext('2d').clearRect(0, 0, scatterCanvas.width, scatterCanvas.height);
            }
        }
    }

    // Utility function to identify column types based on the data
    // On page load, initialize column statistics
    $(document).ready(function() {
        // Initialize column counts directly from the backend data
        const numericCols = [];
        const textCols = [];
        const dateCols = [];
        const otherCols = [];
        
        // Parse the columns from the data preview table
        const columnNames = [];
        $('#dataPreview thead th').each(function() {
            columnNames.push($(this).text().trim());
        });
        
        // DIRECT APPROACH: Categorize each column in the preview
        columnNames.forEach(colName => {
            // Special case handling for columns that should always be numeric
            if (colName.toLowerCase().includes('order') || 
                colName.toLowerCase().includes('number') || 
                colName.toLowerCase().includes('id') || 
                colName.toLowerCase().includes('qty') || 
                colName.toLowerCase().includes('price') || 
                colName.toLowerCase().includes('amount')) {
                // These columns should always be numeric
                numericCols.push(colName);
            } 
            // Otherwise, check dataColumns if available
            else if (dataColumns && dataColumns[colName]) {
                const columnInfo = dataColumns[colName];
                const colType = columnInfo.type || columnInfo.dtype || '';
                
                if (colType.includes('int') || colType.includes('float') || 
                    colType === 'numeric' || colType.includes('number')) {
                    numericCols.push(colName);
                } else if (colType.includes('date') || colType.includes('time')) {
                    dateCols.push(colName);
                } else {
                    textCols.push(colName);
            text: textCols,
            date: dateCols,
            other: otherCols
        };
    }
    
    // Hard-code numeric columns if you're expecting specific ones
    function hardCodeSpecialColumns(columnTypes, allColumns) {
        // Check for specific columns we always want to treat as numeric
        allColumns.forEach(col => {
            if (col.toLowerCase().includes('order') || col.toLowerCase().includes('number')) {
                // If it's not already in numeric columns, add it
                if (!columnTypes.numeric.includes(col)) {
                    columnTypes.numeric.push(col);
                    // Remove from other categories if present
                    columnTypes.text = columnTypes.text.filter(c => c !== col);
                    columnTypes.date = columnTypes.date.filter(c => c !== col);
                    columnTypes.other = columnTypes.other.filter(c => c !== col);
                }
            }
        });
        return columnTypes;
    }

    // Function to update the column statistics display
    function updateColumnStatistics(columnTypes) {
        // Apply special column handling
        let allColumns = [];
        document.querySelectorAll('#dataPreview th').forEach(th => {
            allColumns.push(th.textContent);
        });
        columnTypes = hardCodeSpecialColumns(columnTypes, allColumns);
        
        // Update counts
        document.getElementById('numericColsCount').textContent = columnTypes.numeric.length;
        document.getElementById('textColsCount').textContent = columnTypes.text.length;
        document.getElementById('dateColsCount').textContent = columnTypes.date.length;
        
        // Update column lists
        const maxDisplayColumns = 5; // Maximum columns to show in each category
        
        // Format column lists with ellipsis if too many
        function formatColumnList(columns) {
            if (columns.length === 0) return 'None';
            
            if (columns.length <= maxDisplayColumns) {
                return columns.join(', ');
            } else {
                const visibleCols = columns.slice(0, maxDisplayColumns).join(', ');
                return `${visibleCols}, <span class="text-muted fst-italic">and ${columns.length - maxDisplayColumns} more...</span>`;
            }
        }
        
        // Update numeric columns list
        const numericColsList = document.getElementById('numericColsList');
        if (columnTypes.numeric.length > 0) {
            numericColsList.querySelector('span').innerHTML = formatColumnList(columnTypes.numeric);
            numericColsList.style.display = '';
        } else {
            numericColsList.style.display = 'none';
        }
        
        // Update text columns list
        const textColsList = document.getElementById('textColsList');
        if (columnTypes.text.length > 0) {
            textColsList.querySelector('span').innerHTML = formatColumnList(columnTypes.text);
            textColsList.style.display = '';
        } else {
            textColsList.style.display = 'none';
        }
        
        // Update date columns list
        const dateColsList = document.getElementById('dateColsList');
        if (columnTypes.date.length > 0) {
            dateColsList.querySelector('span').innerHTML = formatColumnList(columnTypes.date);
            dateColsList.style.display = '';
        } else {
            dateColsList.style.display = 'none';
        }
    }

    function fetchAndRender() {
        let url = `/api/data-sources/${dataSourceId}/ai_analysis/`;
        // Show spinner for insights
        document.getElementById('aiInsights').style.display = '';
        document.getElementById('aiInsightsResult').style.display = 'none';
        
        // Fetch data for visualizations and insights
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Process column data
                const columnTypes = analyzeColumnTypes(data.column_info || {});
                updateColumnStatistics(columnTypes);
                
                // Dropdown for visualizations
                numericColumns = data.numeric_columns || [];
                selectedColumn = data.selected_column;
                renderDropdown(numericColumns, selectedColumn);
                
                // Store all visualizations
                allVisualizations = data.visualizations;
                
                // Render charts for selected column
                if (allVisualizations && allVisualizations[selectedColumn]) {
                    renderCharts(allVisualizations[selectedColumn]);
                }
                
                // AI Insights
                let insightHtml = '';
                if (data.key_insights && data.key_insights.length > 0) {
                    insightHtml += '<h5 class="mt-3"><i class="fas fa-lightbulb text-warning me-2"></i>Key Insights</h5>' + 
                                 '<ul class="list-group list-group-flush">' + 
                                 data.key_insights.map(i => `<li class="list-group-item">${i}</li>`).join('') + 
                                 '</ul>';
                }
                
                if (data.recommendations && data.recommendations.length > 0) {
                    insightHtml += '<h5 class="mt-4"><i class="fas fa-clipboard-list text-primary me-2"></i>Recommendations</h5>' + 
                                 '<ul class="list-group list-group-flush">' + 
                                 data.recommendations.map(r => `<li class="list-group-item">${r}</li>`).join('') + 
                                 '</ul>';
                }
                
                if (!insightHtml) {
                    insightHtml = '<div class="alert alert-info mt-3"><i class="fas fa-info-circle me-2"></i>No AI insights available.</div>';
                }
                
                document.getElementById('aiInsightsResult').innerHTML = insightHtml;
                document.getElementById('aiInsights').style.display = 'none';
                document.getElementById('aiInsightsResult').style.display = '';
            })
            .catch(err => {
                console.error('Error fetching data:', err);
                document.getElementById('aiInsightsResult').innerHTML = 
                    '<div class="alert alert-danger mt-3"><i class="fas fa-exclamation-triangle me-2"></i>Error loading AI insights.</div>';
                document.getElementById('aiInsights').style.display = 'none';
                document.getElementById('aiInsightsResult').style.display = '';
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initial fetch
        fetchAndRender();
        // Dropdown event
        document.getElementById('visualizationColumnDropdown').addEventListener('change', function(e) {
            selectedColumn = e.target.value;
            if (allVisualizations && allVisualizations[selectedColumn]) {
                renderCharts(allVisualizations[selectedColumn]);
            }
        });
    });
</script>
</script>
{% endblock %}

{% block extra_css %}
<style>
    .table th,
    .table td {
        white-space: nowrap;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .refresh-preview {
        transition: all 0.3s ease;
    }
    
    .refresh-preview:active {
        transform: rotate(180deg);
    }
</style>
{% endblock %}
