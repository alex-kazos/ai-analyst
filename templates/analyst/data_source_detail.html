{% extends 'base.html' %}

{% block title %}{{ data_source.name }} - AI Analyst{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Data Source Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'data_source_list' %}">Data Sources</a></li>
                    <li class="breadcrumb-item active">{{ data_source.name }}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-1">{{ data_source.name }}</h1>
            <p class="text-muted">{{ data_source.description|default:"No description provided" }}</p>
        </div>
        <div class="d-flex align-items-center">
            <a href="{% url 'question_form' data_source.id %}" class="btn btn-primary me-2">
                <i class="fas fa-question-circle me-2"></i>Ask Questions
            </a>
            <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-chart-line me-2"></i>Create Analysis
            </a>
            <div class="dropdown">
                <button class="btn btn-link p-0 ms-1" type="button" id="dataSourceActions" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 1.6rem;">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dataSourceActions">
                    <li><a class="dropdown-item" href="#" onclick="alert('Rename coming soon!'); return false;">Rename</a></li>
                    <li><a class="dropdown-item" href="#" onclick="alert('Change Description coming soon!'); return false;">Change Description</a></li>
                    <li><a class="dropdown-item" href="#" onclick="alert('Update Dataset coming soon!'); return false;">Update Dataset</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form id="deleteDataSourceForm" method="post" action="{% url 'data_source_delete' data_source.id %}" style="margin-bottom: 0;">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this data source? This action cannot be undone.');">
                                <i class="fas fa-trash-alt me-2"></i>Delete
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    {% if error %}
        <div class="alert alert-danger">
            <h4 class="alert-heading">Error loading data</h4>
            <p>{{ error }}</p>
        </div>
    {% endif %}

    <!-- Data Preview & Overview -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0">Data Preview</h5>
                    <button class="btn btn-sm btn-outline-primary refresh-preview">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        {% if preview_data %}
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        {% for column in columns %}
                                            <th>{{ column.name }} <small class="text-muted">({{ column.type }})</small></th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in preview_data %}
                                         <tr>
                                            {% for cell in row %}
                                                <td>{{ cell|default:""|stringformat:"s"|truncatechars:50 }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="p-4 text-center">
                                <i class="fas fa-table fa-3x text-muted mb-3"></i>
                                <h5>No preview available</h5>
                                <p class="text-muted">Preview could not be generated for this data source.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Showing first 10 rows of the dataset
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Data Source Information -->
            <div class="card shadow-sm mb-4">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Data Source Information</h5>

                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">{{ data_source.created_at|date:"M d, Y" }}</dd>

                        {% if data_source.file %}
                            <dt class="col-sm-5">File Type</dt>
                            <dd class="col-sm-7">{{ data_source.file_type|upper }}</dd>
                        {% endif %}

                        {% if data_source.source_type != 'file' %}
                            <dt class="col-sm-5">Host</dt>
                            <dd class="col-sm-7">{{ data_source.host }}:{{ data_source.port }}</dd>

                            <dt class="col-sm-5">Database</dt>
                            <dd class="col-sm-7">{{ data_source.database }}</dd>
                        {% endif %}

                        {% if columns %}
                            <dt class="col-sm-5">Columns</dt>
                            <dd class="col-sm-7">{{ columns|length }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Quick Analysis -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Quick Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="dataStatistics" class="mb-4">
                        <h6 class="text-primary">Data Statistics</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Total Columns</span>
                                <span class="badge bg-primary rounded-pill">{{ columns|length }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Numeric Columns</span>
                                <span class="badge bg-info rounded-pill" id="numericCols">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Text Columns</span>
                                <span class="badge bg-info rounded-pill" id="textCols">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Date Columns</span>
                                <span class="badge bg-info rounded-pill" id="dateCols">--</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-chart-line me-1"></i>Full Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-robot me-2 text-primary"></i>AI-Generated Insights</h5>
        </div>
        <div class="card-body">
            <div id="aiInsights">
                <!-- AI insights will be loaded here -->
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <h5 class="mb-1">Generating insights...</h5>
                        <p class="mb-0 text-muted">AI is analyzing your data to discover patterns and insights.</p>
                    </div>
                </div>
            </div>
            <div id="aiInsightsResult" class="mt-3" style="display: none;">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-lightbulb text-warning me-2"></i>Key Findings</h5>
                                <ul class="list-unstyled mb-0" id="keyFindings">
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Loading findings...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-chart-pie text-primary me-2"></i>Data Composition</h5>
                                <p class="card-text" id="dataComposition">Analyzing data composition...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Potential Issues</h5>
                                <ul class="list-unstyled mb-0" id="dataIssues">
                                    <li><i class="fas fa-info-circle text-info me-2"></i>Checking for issues...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Automatic Visualizations -->
    <h2 class="h4 mb-3">Automatic Visualizations</h2>
    <style>
    /* Ensure charts stay in frame and are visually balanced */
    #autoVisualizations .card-body {
        min-height: 340px;
    }
    .visualization-canvas-container {
        min-width: 280px;
        max-width: 48%;
        height: 300px;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
    }
    .visualization-canvas-container canvas {
        height: 250px !important;
        max-height: 250px;
        width: 100% !important;
        max-width: 100%;
    }
    @media (max-width: 900px) {
        .visualization-canvas-container {
            max-width: 100%;
        }
    }
    </style>
    <div id="autoVisualizations" class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Automatic Visualizations</h5>
            <div>
                <select id="visualizationColumnDropdown" class="form-select form-select-sm" style="width:auto; display:inline-block;"></select>
            </div>
        </div>
        <div class="card-body" id="visualizationCharts">
            <div class="d-flex flex-wrap justify-content-between">
                <div class="visualization-canvas-container me-3">
                    <h6 class="text-center">Distribution</h6>
                    <canvas id="distributionChart"></canvas>
                </div>
                <div class="visualization-canvas-container">
                    <h6 class="text-center">Values per Column</h6>
                    <canvas id="valueCountsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- AI Insights Result Container (populated by JS) -->
    <div id="aiInsightsResult" class="mt-3"></div>
    <!-- The extra JS for insights and chart rendering should be placed in the extra_js block at the bottom of the template. -->

    <!-- Analyses Section -->
    <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <h2 class="h4 mb-0">Previous Analyses</h2>
        <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-plus-circle me-1"></i>New Analysis
        </a>
    </div>

    {% if analyses %}
        <div class="row" id="analyses">
            {% for analysis in analyses %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <h5 class="mb-0">{{ analysis.name }}</h5>
                            <span class="badge {% if analysis.status == 'completed' %}bg-success{% elif analysis.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ analysis.status|title }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ analysis.description|default:"No description"|truncatechars:100 }}</p>
                            <div class="d-flex align-items-center text-muted small mb-3">
                                <div><i class="fas fa-calendar-alt me-1"></i>{{ analysis.created_at|date:"M d, Y" }}</div>
                                <div class="ms-3"><i class="fas fa-chart-bar me-1"></i>{{ analysis.get_analysis_type_display }}</div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <a href="{% url 'run_analysis' analysis.id %}" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-eye me-1"></i>View Analysis
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card shadow-sm text-center p-4 mb-4">
            <div class="py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                <h3>No Analyses Yet</h3>
                <p class="text-muted mb-4">Create your first analysis to get detailed insights about your data.</p>
                <a href="{% url 'analysis_create' data_source.id %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i>Create Your First Analysis
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    let distributionChart = null;
    let valueCountsChart = null;
    let scatterChart = null;
    let numericColumns = [];
    let selectedColumn = null;
    let allVisualizations = {};
    const dataSourceId = {{ data_source.id }};

    function renderDropdown(columns, current) {
        const dropdown = document.getElementById('visualizationColumnDropdown');
        dropdown.innerHTML = '';
        columns.forEach(col => {
            const opt = document.createElement('option');
            opt.value = col;
            opt.textContent = col;
            if (col === current) opt.selected = true;
            dropdown.appendChild(opt);
        });
    }

    function renderCharts(visualizations) {
        // Value counts chart
        const val = visualizations.value_counts;
        const valCtx = document.getElementById('valueCountsChart').getContext('2d');
        if (valueCountsChart) valueCountsChart.destroy();
        valueCountsChart = new Chart(valCtx, {
            type: val.type,
            data: {
                labels: val.labels,
                datasets: [{
                    label: val.title,
                    data: val.data,
                    backgroundColor: val.background_color,
                    borderColor: val.border_color,
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: true, aspectRatio: 2 }
        });
        // Histogram chart
        const dist = visualizations.histogram;
        const distCtx = document.getElementById('distributionChart').getContext('2d');
        if (distributionChart) distributionChart.destroy();
        distributionChart = new Chart(distCtx, {
            type: dist.type,
            data: {
                labels: dist.labels,
                datasets: [{
                    label: dist.title,
                    data: dist.data,
                    backgroundColor: dist.background_color,
                    borderColor: dist.border_color,
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: true, aspectRatio: 2 }
        });
        // Scatter plot (if present)
        const scatter = visualizations.scatter;
        const scatterCanvas = document.getElementById('scatterChart');
        if (scatterCanvas) {
            if (scatterChart) scatterChart.destroy();
            if (scatter) {
                const scatterCtx = scatterCanvas.getContext('2d');
                scatterChart = new Chart(scatterCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: scatter.title,
                            data: scatter.labels.map((x, i) => ({ x: x, y: scatter.data[i] })),
                            backgroundColor: scatter.background_color,
                            borderColor: scatter.border_color
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, aspectRatio: 2, parsing: false }
                });
            } else {
                scatterCanvas.getContext('2d').clearRect(0, 0, scatterCanvas.width, scatterCanvas.height);
            }
        }
    }

    function fetchAndRender() {
        let url = `/api/data-sources/${dataSourceId}/ai_analysis/`;
        // Show spinner for insights
        document.getElementById('aiInsights').style.display = '';
        document.getElementById('aiInsightsResult').style.display = 'none';
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Dropdown
                numericColumns = data.numeric_columns || [];
                selectedColumn = data.selected_column;
                renderDropdown(numericColumns, selectedColumn);
                // Store all visualizations
                allVisualizations = data.visualizations;
                // Render charts for selected column
                if (allVisualizations && allVisualizations[selectedColumn]) {
                    renderCharts(allVisualizations[selectedColumn]);
                }
                // AI Insights
                let insightHtml = '';
                if (data.key_insights && data.key_insights.length > 0) {
                    insightHtml += '<h5>Key Insights</h5><ul>' + data.key_insights.map(i => `<li>${i}</li>`).join('') + '</ul>';
                }
                if (data.recommendations && data.recommendations.length > 0) {
                    insightHtml += '<h5>Recommendations</h5><ul>' + data.recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>';
                }
                if (!insightHtml) insightHtml = '<div class="text-muted">No AI insights available.</div>';
                document.getElementById('aiInsightsResult').innerHTML = insightHtml;
                document.getElementById('aiInsights').style.display = 'none';
                document.getElementById('aiInsightsResult').style.display = '';
            })
            .catch(err => {
                document.getElementById('aiInsightsResult').innerHTML = '<div class="text-danger">Error loading AI insights.</div>';
                document.getElementById('aiInsights').style.display = 'none';
                document.getElementById('aiInsightsResult').style.display = '';
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initial fetch
        fetchAndRender();
        // Dropdown event
        document.getElementById('visualizationColumnDropdown').addEventListener('change', function(e) {
            selectedColumn = e.target.value;
            if (allVisualizations && allVisualizations[selectedColumn]) {
                renderCharts(allVisualizations[selectedColumn]);
            }
        });
    });
</script>
</script>
{% endblock %}

{% block extra_css %}
<style>
    .table th,
    .table td {
        white-space: nowrap;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .refresh-preview {
        transition: all 0.3s ease;
    }
    
    .refresh-preview:active {
        transform: rotate(180deg);
    }
</style>
{% endblock %}
